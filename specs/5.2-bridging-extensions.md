# Phase 5.2: Bridging Extensions

## Overview

Extend the existing `Bridging.swift` with window list and frame APIs needed for menu bar item repositioning.

## File to Modify

### `Drawer/Bridging/Bridging.swift`

Add the following extensions to the existing `Bridging` enum.

## Code to Add

### 1. Window List Option Set

```swift
// MARK: - Window List Options

extension Bridging {
    /// Options that determine which windows to include in a window list.
    struct WindowListOption: OptionSet {
        let rawValue: Int
        
        /// Include only windows currently on-screen.
        static let onScreen = WindowListOption(rawValue: 1 << 0)
        
        /// Include only menu bar item windows.
        static let menuBarItems = WindowListOption(rawValue: 1 << 1)
        
        /// Include only windows on the active space.
        static let activeSpace = WindowListOption(rawValue: 1 << 2)
    }
}
```

### 2. Window Count Functions

```swift
// MARK: - Window Count

extension Bridging {
    /// Returns the total number of windows.
    private static func getWindowCount() -> Int {
        var count: Int32 = 0
        let result = CGSGetWindowCount(CGSMainConnectionID(), 0, &count)
        if result != .success {
            Logger.bridging.error("CGSGetWindowCount failed with error \(result.rawValue)")
        }
        return Int(count)
    }
    
    /// Returns the number of on-screen windows.
    private static func getOnScreenWindowCount() -> Int {
        var count: Int32 = 0
        let result = CGSGetOnScreenWindowCount(CGSMainConnectionID(), 0, &count)
        if result != .success {
            Logger.bridging.error("CGSGetOnScreenWindowCount failed with error \(result.rawValue)")
        }
        return Int(count)
    }
}
```

### 3. Window List Functions

```swift
// MARK: - Window Lists

extension Bridging {
    /// Returns a list of all window IDs.
    private static func getAllWindowList() -> [CGWindowID] {
        let count = getWindowCount()
        var list = [CGWindowID](repeating: 0, count: count)
        var realCount: Int32 = 0
        
        let result = CGSGetWindowList(
            CGSMainConnectionID(),
            0,
            Int32(count),
            &list,
            &realCount
        )
        
        guard result == .success else {
            Logger.bridging.error("CGSGetWindowList failed with error \(result.rawValue)")
            return []
        }
        
        return Array(list[..<Int(realCount)])
    }
    
    /// Returns a list of on-screen window IDs.
    private static func getOnScreenWindowList() -> [CGWindowID] {
        let count = getOnScreenWindowCount()
        var list = [CGWindowID](repeating: 0, count: count)
        var realCount: Int32 = 0
        
        let result = CGSGetOnScreenWindowList(
            CGSMainConnectionID(),
            0,
            Int32(count),
            &list,
            &realCount
        )
        
        guard result == .success else {
            Logger.bridging.error("CGSGetOnScreenWindowList failed with error \(result.rawValue)")
            return []
        }
        
        return Array(list[..<Int(realCount)])
    }
    
    /// Returns a list of menu bar item window IDs.
    private static func getMenuBarWindowList() -> [CGWindowID] {
        let count = getWindowCount()
        var list = [CGWindowID](repeating: 0, count: count)
        var realCount: Int32 = 0
        
        let result = CGSGetProcessMenuBarWindowList(
            CGSMainConnectionID(),
            0,
            Int32(count),
            &list,
            &realCount
        )
        
        guard result == .success else {
            Logger.bridging.error("CGSGetProcessMenuBarWindowList failed with error \(result.rawValue)")
            return []
        }
        
        return Array(list[..<Int(realCount)])
    }
    
    /// Returns a list of on-screen menu bar item window IDs.
    private static func getOnScreenMenuBarWindowList() -> [CGWindowID] {
        let onScreenSet = Set(getOnScreenWindowList())
        return getMenuBarWindowList().filter { onScreenSet.contains($0) }
    }
}
```

### 4. Public Window List API

```swift
// MARK: - Public Window List API

extension Bridging {
    /// Returns a list of window IDs matching the specified options.
    ///
    /// - Parameter option: Options to filter the window list.
    /// - Returns: Array of window IDs matching the criteria.
    static func getWindowList(option: WindowListOption = []) -> [CGWindowID] {
        let list: [CGWindowID]
        
        if option.contains(.menuBarItems) {
            if option.contains(.onScreen) {
                list = getOnScreenMenuBarWindowList()
            } else {
                list = getMenuBarWindowList()
            }
        } else if option.contains(.onScreen) {
            list = getOnScreenWindowList()
        } else {
            list = getAllWindowList()
        }
        
        if option.contains(.activeSpace) {
            return list.filter { isWindowOnActiveSpace($0) }
        }
        
        return list
    }
}
```

### 5. Window Frame API

```swift
// MARK: - Window Frame

extension Bridging {
    /// Returns the frame for the window with the specified ID.
    ///
    /// - Parameter windowID: The window identifier.
    /// - Returns: The window frame in screen coordinates, or nil if unavailable.
    static func getWindowFrame(for windowID: CGWindowID) -> CGRect? {
        var rect = CGRect.zero
        let result = CGSGetScreenRectForWindow(CGSMainConnectionID(), windowID, &rect)
        
        guard result == .success else {
            Logger.bridging.error("CGSGetScreenRectForWindow failed with error \(result.rawValue)")
            return nil
        }
        
        return rect
    }
}
```

### 6. Active Space Check

```swift
// MARK: - Space Utilities

extension Bridging {
    /// Returns the identifier of the currently active space.
    static var activeSpaceID: CGSSpaceID {
        CGSGetActiveSpace(CGSMainConnectionID())
    }
    
    /// Returns whether the specified window is on the active space.
    ///
    /// - Parameter windowID: The window identifier.
    /// - Returns: True if the window is on the active space.
    static func isWindowOnActiveSpace(_ windowID: CGWindowID) -> Bool {
        guard let spaces = CGSCopySpacesForWindows(
            CGSMainConnectionID(),
            CGSSpaceMask.allSpaces.rawValue,
            [windowID] as CFArray
        ) else {
            return false
        }
        
        guard let spaceIDs = spaces.takeRetainedValue() as? [CGSSpaceID] else {
            return false
        }
        
        return spaceIDs.contains(activeSpaceID)
    }
}
```

### 7. Logger Extension

```swift
// MARK: - Logger

private extension Logger {
    static let bridging = Logger(subsystem: Bundle.main.bundleIdentifier ?? "Drawer", category: "Bridging")
}
```

## CGS Function Declarations

Ensure the following CGS function declarations exist in the bridging header or a separate declarations file:

```swift
// These should already exist or be added to a CGSPrivate.swift file

typealias CGSConnectionID = UInt32
typealias CGSSpaceID = UInt64
typealias CGSWindowID = UInt32

struct CGSSpaceMask: OptionSet {
    let rawValue: Int
    static let allSpaces = CGSSpaceMask(rawValue: 1 << 0)
    static let allVisibleSpaces = CGSSpaceMask(rawValue: 1 << 1)
}

// Function declarations (these call into private frameworks)
func CGSMainConnectionID() -> CGSConnectionID
func CGSGetWindowCount(_ cid: CGSConnectionID, _ pid: Int32, _ count: UnsafeMutablePointer<Int32>) -> CGError
func CGSGetOnScreenWindowCount(_ cid: CGSConnectionID, _ pid: Int32, _ count: UnsafeMutablePointer<Int32>) -> CGError
func CGSGetWindowList(_ cid: CGSConnectionID, _ pid: Int32, _ count: Int32, _ list: UnsafeMutablePointer<CGWindowID>, _ outCount: UnsafeMutablePointer<Int32>) -> CGError
func CGSGetOnScreenWindowList(_ cid: CGSConnectionID, _ pid: Int32, _ count: Int32, _ list: UnsafeMutablePointer<CGWindowID>, _ outCount: UnsafeMutablePointer<Int32>) -> CGError
func CGSGetProcessMenuBarWindowList(_ cid: CGSConnectionID, _ pid: Int32, _ count: Int32, _ list: UnsafeMutablePointer<CGWindowID>, _ outCount: UnsafeMutablePointer<Int32>) -> CGError
func CGSGetScreenRectForWindow(_ cid: CGSConnectionID, _ wid: CGWindowID, _ rect: UnsafeMutablePointer<CGRect>) -> CGError
func CGSGetActiveSpace(_ cid: CGSConnectionID) -> CGSSpaceID
func CGSCopySpacesForWindows(_ cid: CGSConnectionID, _ mask: Int, _ windows: CFArray) -> Unmanaged<CFArray>?
```

## Acceptance Criteria

- [ ] `Bridging.getWindowList(option:)` returns window IDs based on options
- [ ] `Bridging.getWindowFrame(for:)` returns correct frame for valid window ID
- [ ] `Bridging.getWindowFrame(for:)` returns nil for invalid window ID
- [ ] `Bridging.isWindowOnActiveSpace(_:)` correctly identifies active space windows
- [ ] Menu bar items are correctly filtered when using `.menuBarItems` option
- [ ] Typecheck passes: `xcodebuild -scheme Drawer build`

## Testing

```swift
// In DrawerTests/Bridging/BridgingTests.swift

import XCTest
@testable import Drawer

final class BridgingTests: XCTestCase {
    func testGetWindowList() {
        let allWindows = Bridging.getWindowList()
        XCTAssertFalse(allWindows.isEmpty, "Should have at least some windows")
    }
    
    func testGetMenuBarWindowList() {
        let menuBarWindows = Bridging.getWindowList(option: .menuBarItems)
        XCTAssertFalse(menuBarWindows.isEmpty, "Should have menu bar items")
    }
    
    func testGetWindowFrame() {
        let menuBarWindows = Bridging.getWindowList(option: .menuBarItems)
        guard let firstWindow = menuBarWindows.first else {
            XCTFail("No menu bar windows")
            return
        }
        
        let frame = Bridging.getWindowFrame(for: firstWindow)
        XCTAssertNotNil(frame, "Should get frame for valid window")
        XCTAssertGreaterThan(frame!.width, 0, "Frame should have width")
        XCTAssertGreaterThan(frame!.height, 0, "Frame should have height")
    }
    
    func testInvalidWindowFrame() {
        let frame = Bridging.getWindowFrame(for: 999999)
        XCTAssertNil(frame, "Should return nil for invalid window ID")
    }
}
```

## Dependencies

- Existing `Bridging.swift` infrastructure
- CGS private function declarations
