# 5.9 Menu Bar Layout - Section Reassignment

## Overview

This specification defines the end-to-end behavior for rearranging menu bar icons between **Shown (always visible)**, **Hidden**, and **Always Hidden** sections using Settings -> Menu Bar Layout. It focuses on user-driven drag-and-drop moves that **both update the UI and physically reposition the real menu bar icons**, with reliable persistence across launches.

This spec builds on prior layout fixes:
- **Spec 5.6**: Captured order is the source of truth for display
- **Spec 5.7**: Physical repositioning works via windowID cache and IconMatcher

## Problem Statement

Users can drag icons in the Menu Bar Layout UI, but the resulting section assignment is not always reflected in the actual menu bar, and always-hidden behavior is unclear when the feature is disabled. The result is a mismatch between what users see in settings and what they see in the menu bar.

## Goals

- Users can drag icons between **Shown**, **Hidden**, and **Always Hidden** sections in settings.
- The **real menu bar** reflects the new section membership immediately after a drop.
- Moves are **persisted** and restored on relaunch.
- Drag-and-drop clearly communicates **disabled states** (immovable items, missing permissions, always-hidden disabled).
- Errors revert the UI back to the real menu bar state to avoid drift.

## Non-Goals

- No new sections beyond the three existing ones.
- No automatic sorting or smart grouping.
- No changes to how menu bar items are captured beyond existing capture/reconcile behavior.

## User Experience

### Layout Sections

- **Shown Items**: Always visible in the menu bar.
- **Hidden Items**: Visible only when Drawer expands the menu bar.
- **Always Hidden Items**: Always off-screen (left of the always-hidden control).

### Drag-and-Drop Behavior

- Users can drag icons **within** a section to reorder.
- Users can drag icons **between** sections to change visibility category.
- Spacers can be moved between sections, but do not reposition real icons.
- Immovable items display a lock indicator and cannot be dragged.
- If permissions are missing, drag is disabled and a warning is shown.
 - Spacers are **not allowed** in Always Hidden.

### Always Hidden Toggle

- Users can always drag into Always Hidden.
- If Always Hidden is disabled, items dropped there are treated as **Hidden** and shown in the Hidden section UI.
- When Always Hidden is re-enabled later, items explicitly assigned to Always Hidden should move into that section automatically.

## Data and Persistence

### Primary Data

- `SettingsLayoutItem` stores `section` and `order` for user intent.
- `SettingsManager.menuBarLayout` persists the layout preferences.
- `SettingsManager.savedIconPositions` persists the real menu bar order after moves.

### Persistence Rules

- Layout updates are written **only after** a move succeeds in the real menu bar.
- If the physical reposition fails, the UI reverts to the last captured state and **does not persist** the attempted move.

## Technical Design

### High-Level Flow

```
User drags icon in Settings -> Menu Bar Layout
    -> UI validates drop target (permissions, section enabled, immovable)
    -> MenuBarLayoutViewModel.moveItem() updates local layout
    -> performReposition() finds IconItem and calculates destination
    -> IconRepositioner.move() performs Command+Drag reposition
    -> On success: save current positions and persist layout
    -> On failure: show error, refresh layout from capture
```

### Section Boundaries

- **Shown**: items to the right of `hiddenControlItem`
- **Hidden**: items between `alwaysHiddenControlItem` and `hiddenControlItem`
- **Always Hidden**: items to the left of `alwaysHiddenControlItem`

### Always Hidden Disabled Handling

- If `SettingsManager.shared.alwaysHiddenSectionEnabled` is `false`:
  - Drops into Always Hidden are accepted but **re-routed to Hidden** for physical positioning.
  - The layout item should retain its user-intent section as Always Hidden for future re-enable.

### Failure Handling

If any of these occur, the move is considered a failure:
- `IconMatcher` cannot find a matching `IconItem`
- Destination cannot be calculated (missing control items)
- `IconRepositioner` throws a `RepositionError`

On failure:
- Show a warning alert explaining why the move could not be completed.
- Refresh layout from capture to re-sync UI with reality.
- Do not persist the attempted move to `SettingsManager.menuBarLayout`.

## Implementation Plan

### Primary Files

- `Drawer/UI/Settings/SettingsMenuBarLayoutView.swift`
  - Always Hidden is a valid drop target.
  - If Always Hidden is disabled, show a subtle notice that the item will be placed in Hidden for now.

- `Drawer/UI/Settings/MenuBarLayoutViewModel.swift`
  - If Always Hidden is disabled, map `.alwaysHidden` moves to `.hidden` **for physical repositioning only**.
  - Preserve user intent in persisted layout as `.alwaysHidden`.
  - Defer persistence until after a successful reposition.
  - On failure, refresh from capture to avoid UI drift.

- `Drawer/Core/Managers/SettingsManager.swift`
  - Ensure `alwaysHiddenSectionEnabled` is the single source of truth for section availability.

### Logging

Use existing `MenuBarLayoutViewModel` logger and add/keep:
- Drag start, drop target, and section changes.
- Reposition attempts, destination calculations, and failure reasons.
- Persistence success/failure events.

## Testing

### Manual Test Cases

1. **Move Shown -> Hidden**
   - Drag an icon from Shown to Hidden.
   - Verify it moves to the hidden area in the real menu bar.

2. **Move Hidden -> Shown**
   - Drag an icon from Hidden to Shown.
   - Verify it remains visible when the menu bar is collapsed.

3. **Move Shown -> Always Hidden (Enabled)**
   - Enable Always Hidden section.
   - Drag an icon into Always Hidden.
   - Verify it disappears even when Drawer expands the menu bar.

4. **Move into Always Hidden (Disabled)**
   - Disable Always Hidden section.
   - Attempt to drag an icon into Always Hidden.
   - Verify the item appears in Hidden while the Always Hidden section is disabled.
   - Re-enable Always Hidden and verify the item moves into Always Hidden.

5. **Reorder Within Section**
   - Reorder items within Hidden.
   - Verify actual menu bar ordering changes accordingly.

6. **Failure Reverts UI**
   - Simulate a reposition failure (e.g., remove permissions).
   - Verify UI refreshes back to actual menu bar layout.

### Unit Tests

Add/extend tests to cover:
- Move blocked when always-hidden is disabled.
- Persistence only after successful reposition.
- Failure path reverts local state and does not persist.

## Definition of Done

- [ ] Drag-and-drop moves update both UI and actual menu bar sections.
- [ ] Always Hidden accepts drops even when disabled, but places items in Hidden until re-enabled.
- [ ] Failed repositioning does not persist layout changes.
- [ ] UI always re-syncs to captured state after errors.
- [ ] Manual test cases verified.

## Decision

- Persist **only after** a successful physical reposition. UI changes are reverted on failure.
