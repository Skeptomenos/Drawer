# Phase 5: Drag-to-Reposition Menu Bar Icons

## Overview

This phase implements the ability to physically reposition menu bar icons by dragging them in the Settings > Menu Bar Layout view. The implementation uses CGEvent simulation (based on Ice's proven approach) to programmatically move icons.

## Sub-Phases

| Phase | Name | Description | Estimated Effort |
|-------|------|-------------|------------------|
| 5.1 | Core Models | MenuBarItem and MenuBarItemInfo models | 1 day |
| 5.2 | Bridging Extensions | Window list and frame APIs | 0.5 day |
| 5.3 | IconRepositioner Engine | CGEvent-based repositioning | 2-3 days |
| 5.4 | Settings UI Integration | Hook repositioner to drag-drop | 1-2 days |
| 5.5 | Persistence | Save/restore icon positions | 1 day |

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    SettingsMenuBarLayoutView                     │
│                         (SwiftUI)                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ onDrop()
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      IconRepositioner                            │
│                    (Core/Engines/)                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ move(item:  │  │ waitFor     │  │ createMoveEvent()       │  │
│  │ to:)        │  │ FrameChange │  │ postEvent()             │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ CGEvent / CGS APIs
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Bridging                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ getWindowFrame  │  │ getMenuBarWindow│  │ isWindowOn      │  │
│  │ (for:)          │  │ List()          │  │ ActiveSpace()   │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     macOS Menu Bar                               │
│              (NSStatusItem windows)                              │
└─────────────────────────────────────────────────────────────────┘
```

## Key Technical Decisions

### 1. CGEvent Simulation (Not Accessibility API)

We use CGEvent simulation with Command modifier, following Ice's approach:

**Why:**
- No AXUIElement tree traversal needed
- Direct window ID targeting
- Proven reliable in Ice
- App Store compatible (uses public CGEvent APIs)

**How:**
```swift
// Create mouse down with Command flag
let event = CGEvent(mouseEventSource: source, mouseType: .leftMouseDown, ...)
event.flags = .maskCommand
event.setIntegerValueField(.windowID, value: windowID)
event.setIntegerValueField(.mouseEventWindowUnderMousePointer, value: windowID)
```

### 2. Frame Change Verification

Don't trust that posting events worked. Verify the window actually moved:

```swift
func waitForFrameChange(of item: MenuBarItem, timeout: Duration) async throws {
    let initialFrame = Bridging.getWindowFrame(for: item.windowID)
    while true {
        if Bridging.getWindowFrame(for: item.windowID) != initialFrame {
            return // Success
        }
        try await Task.sleep(for: .milliseconds(10))
    }
}
```

### 3. Retry with Wake-Up

Some apps don't respond to the first move event. Wake them up:

```swift
for attempt in 1...5 {
    do {
        try await moveItemWithoutRetry(item, to: destination)
        return
    } catch {
        try await wakeUpItem(item) // Click to wake
    }
}
```

### 4. Mouse Cursor Handling

Hide cursor during move to prevent visual artifacts:

```swift
MouseCursor.hide()
defer { 
    MouseCursor.warp(to: originalLocation)
    MouseCursor.show() 
}
```

## Dependencies

- `Bridging.swift` - Existing CGS connection infrastructure
- `SettingsMenuBarLayoutView.swift` - Existing drag-drop UI
- `SettingsManager.swift` - For persistence

## Files to Create

| File | Location | Purpose |
|------|----------|---------|
| `MenuBarItem.swift` | `Drawer/Models/` | Menu bar item representation |
| `MenuBarItemInfo.swift` | `Drawer/Models/` | Item identifier (namespace + title) |
| `IconRepositioner.swift` | `Drawer/Core/Engines/` | Core repositioning engine |
| `MouseCursor.swift` | `Drawer/Utilities/` | Cursor hide/show/warp helpers |

## Files to Modify

| File | Changes |
|------|---------|
| `Bridging.swift` | Add window frame/list APIs |
| `SettingsMenuBarLayoutView.swift` | Hook repositioner to onDrop |
| `SettingsManager.swift` | Add position persistence |
| `AppDelegate.swift` | Call position restore on launch |

## Testing Strategy

### Unit Tests
- `MenuBarItemTests.swift` - Model creation, sorting
- `IconRepositionerTests.swift` - Mock event creation (can't test actual moves in unit tests)

### Integration Tests (Manual)
1. Drag icon from Shown to Hidden - verify real menu bar changes
2. Drag icon from Hidden to Always Hidden - verify it disappears
3. Reorder icons within Shown - verify order changes
4. Try to drag Control Center - verify lock indicator appears
5. Restart app - verify positions restored

## Success Criteria

- [ ] Dragging icon in Settings moves it in real menu bar
- [ ] Works for all three sections (Shown, Hidden, Always Hidden)
- [ ] Within-section reordering works
- [ ] System icons show lock and cannot be moved
- [ ] Positions persist across app restart
- [ ] 90%+ success rate for moves
- [ ] < 500ms per move operation
